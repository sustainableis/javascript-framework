"use strict";!function(){var topics={},_subscribe=function(topic,listener){topics[topic]||(topics[topic]={queue:[]}),topics[topic].queue.push(listener)},_unsubscribe=function(index){delete topics[topic].queue[index]},_publish=function(topic,message){var message=message||{};topics[topic]&&topics[topic].queue.length&&topics[topic].queue.forEach(function(listener){listener(message)})};window.events={subscribe:_subscribe,unsubscribe:_unsubscribe,publish:_publish,topics:topics}}(),function(angular){angular.module("sis",["ngResource","sis.api","sis.modules"]),angular.module("sis.api",[]),angular.module("sis.modules",[]),angular.module("sis.api").constant("url","http://api.sustainableis.com/"),angular.module("sis.api").constant("version","v1"),angular.module("sis.modules").constant("path","http://d10t57k8pf74ki.cloudfront.net/**"),angular.module("sis.api").provider("sisConfiguration",function(){this.token=null,this.debug=!1,this.$get=["$injector",function(){return{token:this.token,debug:this.debug}}]}),angular.module("sis.api").factory("authInterceptor",["$q","sisConfiguration",function($q,sisConfiguration){return{request:function(config){return config.headers=config.headers||{},config.data&&"object"==typeof config.data&&(config.data=$.param(config.data)),sisConfiguration.token&&(config.headers.Authorization="Bearer "+sisConfiguration.token),config},response:function(response){return 503===response.status,response||$q.when(response)}}}]),angular.module("sis.api").config(["$httpProvider","$logProvider","sisConfigurationProvider",function($httpProvider,$logProvider,sisConfigurationProvider){$httpProvider.defaults.headers.post["Content-Type"]="application/x-www-form-urlencoded; charset=UTF-8;",$httpProvider.interceptors.push("authInterceptor"),setTimeout(function(){$logProvider.debugEnabled(sisConfigurationProvider.debug||!1)})}]),angular.module("sis.modules").config(["$sceDelegateProvider","path",function($sceDelegateProvider,path){$sceDelegateProvider.resourceUrlWhitelist(["self",path])}])}(window.angular),function(angular){angular.module("sis.modules").provider("dataStore",function(){this.cache={},this.$get=["$injector","$log","OauthService","FacilitiesService","OrganizationsService","BuildingsService","FeedsService","OutputsService","UsersService","WeatherService",function($injector,$log){var _this=this,_decode_topic=function(topic){var decoded={},components=topic.split("/");return _.each(components,function(component){var _components=component.split(":"),key=_components[0],value=_components[1];decoded[key]=value}),decoded},_call=function(topic,callback){var topic=_decode_topic(topic),service_name=topic.service.charAt(0).toUpperCase()+topic.service.slice(1)+"Service",service=$injector.get(service_name),call_params=_.omit(topic,"service");service.query(call_params,function(data){callback(data)})},_get=function(topic,callback){return _.has(_this.cache,topic)?($log.debug("Returned",_this.cache[topic],"from cache","for topic",topic),callback(_this.cache[topic])):void _call(topic,function(data){$log.debug("Returned",data,"from API","for topic",topic),_this.cache[topic]=data,callback(data)})};return{get:_get}}]})}(window.angular),function(angular,events){angular.module("sis.modules").provider("sisModules",function(){this.modules=[],this.$get=["$injector","$q","$log","dataStore","ModulesService",function($injector,$q,$log,dataStore,ModulesService){var _this=this,_discover=function(){var modules=$(".module");_.each(modules,function(module){var id=angular.element(module).data("id");_this.modules.push({id:id})})},_init=function(callback){var calls=[];_.each(_this.modules,function(module){var call=ModulesService.query({id:module.id,controller:"channels"},function(data){module.channels=data,$log.debug("Framework sent",data,"on",module.id+":channels"),events.publish(module.id+":channels",data)});calls.push(call)}),$q.all(calls).then(function(){callback(),events.subscribe("new",function(data){$log.debug("Framework got",data,"on","new"),dataStore.get(data.channel,function(_data){$log.debug("Framework sent",_data,"on",data.caller),events.publish(data.caller,_data)})}),events.subscribe("refresh",function(data){$log.debug("Framework got",data,"on","new")}),_.each(_this.modules,function(module){_.each(module.channels,function(channel){events.subscribe(channel.topic,function(data){$log.debug("Framework got",data,"on",channel.topic)}),dataStore.get(channel.topic,function(data){$log.debug("Framework sent",data,"on",module.id+":"+channel.route),events.publish(module.id+":"+channel.route,data)})})})})};return{discover:_discover,init:_init}}]})}(window.angular,window.events),function(angular){angular.module("sis.api").factory("FacilitiesService",["$resource","url","version",function($resource,url,version){return $resource(url+version+"/facilities/:id/:controller/:verb/:action",{id:"@id",controller:"@controller",verb:"@verb",action:"@action"})}])}(window.angular),function(angular){angular.module("sis.api").factory("BuildingsService",["$resource","url","version",function($resource,url,version){return $resource(url+version+"/buildings/:id/:controller/:verb",{id:"@id",controller:"@controller",verb:"@verb"})}])}(window.angular),function(angular){angular.module("sis.api").factory("FeedsService",["$resource","url","version",function($resource,url,version){return $resource(url+version+"/feeds/:id/:controller/:verb",{id:"@id",controller:"@controller",verb:"@verb"})}])}(window.angular),function(angular){angular.module("sis.api").factory("ModulesService",["$resource",function(){var modules=[{id:1,tag:"table-module-angular"},{id:2,tag:"table-module-angular"},{id:3,tag:"dropdown-module-angular"},{id:4,tag:"table-module"}],configurations=[{id:1,module_id:1,refresh:10,stale:60,name:"Feeds for Facility",headers:JSON.stringify(["Id","Created At","description","Key"])},{id:2,module_id:2,refresh:10,stale:60,name:"Outputs for Facility",headers:JSON.stringify(["Id","Created At","description","Key"])},{id:3,module_id:3,refresh:10,stale:60,name:"Select Facility"},{id:4,module_id:4,refresh:10,stale:60,name:"Polymer table module",headers:JSON.stringify(["Id","Created At","description","Key"])}],channels=[{id:1,module_id:1,route:"data",topic:"service:facilities/id:1/controller:feeds"},{id:2,module_id:1,route:"configuration",topic:"service:modules/id:1/controller:configuration"},{id:3,module_id:2,route:"data",topic:"service:facilities/id:1/controller:outputs"},{id:4,module_id:2,route:"configuration",topic:"service:modules/id:2/controller:configuration"},{id:5,module_id:3,route:"data",topic:"service:facilities"},{id:6,module_id:3,route:"configuration",topic:"service:modules/id:3/controller:configuration"},{id:7,module_id:4,route:"data",topic:"service:facilities/id:1/controller:feeds"},{id:8,module_id:4,route:"configuration",topic:"service:modules/id:1/controller:configuration"}];return{query:function(options,callback){var results;switch(options.controller){case"configuration":results=_.findWhere(configurations,{module_id:parseInt(options.id)});break;case"channels":results=_.where(channels,{module_id:options.id});break;default:results=_.findWhere(modules,{id:options.id})}callback(results)}}}])}(window.angular),function(angular){angular.module("sis.api").factory("OauthService",["$resource","url",function($resource,url){return $resource(url+"oauth/:controller",{controller:"@controller"})}])}(window.angular),function(angular){angular.module("sis.api").factory("OrganizationsService",["$resource","url","version",function($resource,url,version){return $resource(url+version+"/organizations/:id/:controller/:verb",{id:"@id",controller:"@controller",verb:"@verb"})}])}(window.angular),function(angular){angular.module("sis.api").factory("OutputsService",["$resource","url","version",function($resource,url,version){return $resource(url+version+"/outputs/:id/:controller/:verb",{id:"@id",controller:"@controller",verb:"@verb"})}])}(window.angular),function(angular){angular.module("sis.api").factory("UsersService",["$resource","url","version",function($resource,url,version){return $resource(url+version+"/users/:id/:controller/:verb",{id:"@id",controller:"@controller",verb:"@verb"})}])}(window.angular),function(angular){angular.module("sis.api").factory("WeatherService",["$resource","url","version",function($resource,url,version){return $resource(url+version+"/weather/:controller/:id/:verb",{id:"@id",controller:"@controller",verb:"@verb"})}])}(window.angular);